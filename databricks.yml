bundle:
  name: download-pipeline

targets:
  dev:
    mode: development
    default: true

resources:
  jobs:
    Download_pipeline:
      name: Download pipeline

      # define a reusable job cluster for this job (can be changed in UI)
      job_clusters:
        - job_cluster_key: default_cluster
          new_cluster:
            spark_version: 15.4.x-scala2.12   # adjust version
            node_type_id: Standard_DS3_v2     # adjust node type
            num_workers: 1

      tasks:
        - task_key: Prepare_volume
          job_cluster_key: default_cluster
          notebook_task:
            notebook_path: ./notebooks/1. prepare volume.ipynb
            base_parameters:
              catalog: dev
              schema: tools
              volume: testing
            source: GIT

        - task_key: prepare_endpoints
          job_cluster_key: default_cluster
          notebook_task:
            notebook_path: ./notebooks/2. prepare endpoints.ipynb
            base_parameters:
              endpoint_table: dev.tools.endpoints
            source: GIT

        - task_key: for_each_endpoint
          depends_on:
            - task_key: Prepare_volume
            - task_key: prepare_endpoints
          for_each_task:
            inputs: "{{tasks.prepare_endpoints.values.endpoints}}"
            concurrency: 4
            task:
              task_key: download_endpoint
              job_cluster_key: default_cluster
              notebook_task:
                notebook_path: ./notebooks/3. download api.ipynb
                base_parameters:
                  endpoint_payload: "{{input}}"
                  run_folder: "{{tasks.Prepare_volume.values.run_folder}}"
                source: GIT

      queue:
        enabled: true
